{% metadata_file .yamato/metadata.yml %}
---

{% for config in all_configurations %}
{% for editor in config.editors %}
{% for platform in config.platforms %}
test_{{ config.name }}_{{ platform }}_{{ editor }}:
  name : Test {{ config.name }} {{ editor }} on {{ platform }}
  agent:
    type: {{ platform.type }}
    image: {{ platform.image }}
    flavor: {{ platform.flavor}}
  variables:
  {% if platform.name == "centos" %}
    DISPLAY: ":0"
  {% endif %}
  commands:
    - npm install upm-ci-utils@stable -g --registry https://artifactory.prd.cds.internal.unity3d.com/artifactory/api/npm/upm-npm
    - upm-ci package test -u {{ editor }} {{ config.args }}
  artifacts:
    logs:
      paths:
        - "upm-ci~/test-results/**/*"
  dependencies:
    - .yamato/package-pack.yml#pack
{% endfor %}
{% endfor %}
{% endfor %}

test_trigger:
  name: Package Tests Trigger
  triggers:
    branches:
      only:
      - "/^(master)|(release[/]\\d+[.]\\d+)$/"
    pull_requests:
      - targets:
          only:
            - "/.*/"
    cancel_old_ci: true
  dependencies:
    - .yamato/package-pack.yml#pack
    {% for config in test_configurations %}
    {% for editor in config.editors %}
    {% for platform in config.platforms %}
    - .yamato/package-test.yml#test_{{config.name}}_{{platform.name}}_{{editor}}
    {% endfor %}
    {% endfor %}
    {% endfor %}
